---
title: "Supporting nice tables for Q reviews"
author: adapted from"jdavis"
date: "1/4/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


We'll be reproducing the table located here:
https://docs.google.com/presentation/d/1tR3a81fd5mtkAX-RkX3hZv7skahkHryIrbrI7mli1Pc/edit#slide=id.p6


T
## Libraries + globals
  
```{r}
library(tidyverse)
library(glamr)
#install.packages("gt")
library(gt)
library(googledrive)
library(googlesheets4)
library(ICPIutilities)
library(glitr)
library(RColorBrewer)
library(scales)
library(dplyr)
library(extrafont)
library(scales)
library(tidytext)
library(patchwork)
library(ggtext)
library(glue)
library(janitor)
library(lubridate)


pal <- RColorBrewer::brewer.pal(5, "Spectral")[2:5] ## we'll come back to this
save_path <- "2021-01-18"

```
  
##munging your data
  We're going to look at a simple table that's in long format and convert to wide using `pivot_wider
  
```{r}
## load raw OU x IM file
 raw <- read_msd("Data/MER_Structured_Datasets_OU_IM_FY19-21_20210514_v1_1.txt")
df<-as.data.frame(raw)
# # 
  df<-df%>% dplyr::filter(operatingunit == "Democratic Republic of the Congo",
          standardizeddisaggregate == "Total Numerator",
  
                    indicator %in% c("HTS_TST", "HTS_TST_POS", "TX_NEW", "TX_CURR", "TX_NET_NEW", "VMMC_CIRC", "PrEP_NEW"),
          fiscal_year %in% c(2021))%>% 
   reshape_msd("long") 
   
# # group by period types and quarters
 df<-df%>%
   mutate(period_types = glue("{`period`} {`period_type`}"))
   
  df <- df %>% 
   dplyr::group_by(fundingagency,indicator, period_types) %>% 
   dplyr::summarise(value = sum(value))
 
 

#filter to usaid and pivot longer
  df <- df %>%
  #filter(fundingagency == "USAID") %>% 
  tidyr::pivot_wider(names_from = period_types,
              values_from = value)
 df<-df%>%
   mutate(`FY21 Achieved` =  `FY21 cumulative`/`FY21 targets`)%>%
   rename(`FY21 Q1`=`FY21Q1 results`,
          `FY21 Q2`=`FY21Q2 results`)



```

```{r}

df %>% 
  gt()

## you can see that without doing any modification whatsoever, `gt` spits out a pretty good table with just the defaults
## but we want to clean this up a bit




df <- df %>%
    dplyr::relocate(`FY21 cumulative`, .before = `FY21 targets`) %>% 
    dplyr::relocate(`FY21 targets`, .before = `FY21 Achieved`) %>%
    dplyr::relocate(`FY21 Q2`, .before=`FY21 cumulative`)%>%
    dplyr::relocate(`FY21 Q1`, .before=`FY21 Q2`)%>%
    mutate(indicator = fct_relevel(indicator, "HTS_TST",
                                   "HTS_TST_POS",
                                   "TX_NEW",
                                   "TX_CURR",
                                   "TX_NET_NEW",
                                   "VMMC_CIRC",
                                   "PrEP_NEW")) %>% 
    arrange(indicator)
```

 


```{r}
#add in decimals, and commas, and get rid of NAs
df %>% 
  gt(groupname_col = "fundingagency",
    rowname_col = "indicator") %>% 
  fmt_number(
    columns = vars(
      `FY21 Q1`,
      `FY21 Q2`,
      `FY21 cumulative`,
      `FY21 targets`),
    decimals = 0
  ) %>% 
  fmt_percent(
    columns = vars(`FY21 Achieved`),
    decimals = 0
  )%>%
  fmt_missing(columns = everything(),
            missing_text = "-")%>%
   tab_options(
    table.font.names = "Source Sans Pro"
    ) %>% 
   cols_width(
    vars(indicator) ~ px(140),
    everything() ~ px(80)
  )%>%
 
  tab_style(
    style = cell_borders(
      sides = "right",
      weight = px(1.5),
    ),
    locations = cells_body(
      columns = everything(),
      rows = everything()
    ))%>%


  tab_style(style = cell_fill(color = pal[4]),      ## defining the what (the 4th value of the pal object)
              locations = cells_body(                 ## telling it where (ie, the body of a cell)
                columns = vars(`FY21 Achieved`),      ## which col this refers to (note `vars()`)
                rows = `FY21 Achieved` >= 1.1)) %>%   ## the argument
    tab_style(style = cell_fill(color = pal[3]),
              locations = cells_body(
                columns = vars(`FY21 Achieved`),
                rows = `FY21 Achieved` < 1.1)) %>% 
    tab_style(style = cell_fill(color = pal[2]),
              locations = cells_body(
                columns = vars(`FY21 Achieved`),
                rows = `FY21 Achieved` < .9)) %>% 
    tab_style(style = cell_fill(color = pal[1]),
              locations = cells_body(
                columns = vars(`FY21 Achieved`),
                rows = `FY21 Achieved` < .75))%>%
 tab_header(title = "PEPFAR/DRC results, performance, and targets FY21 Q1-Q2") %>% 
  tab_source_note("Source: MSD FY20Q2i 2021-05-20")
  


# a few things to note: become familiar with the defaults for some of these (see help) for ex, we didn't include 
# `use_seps = TRUE` after line 136. This is true by default and defaults to a "," separator, but you can change this

```
Do the same as above but for just USAID partners
```{R}
df<-as.data.frame(raw)
# # 
  df<-df%>% dplyr::filter(operatingunit == "Democratic Republic of the Congo",
          standardizeddisaggregate == "Total Numerator",
  
                    indicator %in% c("HTS_TST", "HTS_TST_POS", "TX_NEW", "TX_CURR", "TX_NET_NEW", "VMMC_CIRC", "PrEP_NEW"),
          fiscal_year %in% c(2021))%>% 
   reshape_msd("long") 
   
# # group by period types and quarters
 df<-df%>%
   mutate(period_types = glue("{`period`} {`period_type`}"))
   
  df <- df %>% 
   dplyr::group_by(fundingagency,primepartner,indicator, period_types) %>% 
   dplyr::summarise(value = sum(value))
 
 

#filter to usaid and pivot longer
  df <- df %>%
  filter(fundingagency == "USAID") %>% 
  tidyr::pivot_wider(names_from = period_types,
              values_from = value)
 df<-df%>%
   mutate(`FY21 Achieved` =  `FY21 cumulative`/`FY21 targets`)%>%
   rename(`FY21 Q1`=`FY21Q1 results`,
          `FY21 Q2`=`FY21Q2 results`,
          `Prime Partner`=`primepartner`)
df <- df %>%
    dplyr::relocate(`FY21 cumulative`, .before = `FY21 targets`) %>% 
    dplyr::relocate(`FY21 targets`, .before = `FY21 Achieved`) %>%
    dplyr::relocate(`FY21 Q2`, .before=`FY21 cumulative`)%>%
    dplyr::relocate(`FY21 Q1`, .before=`FY21 Q2`)%>%
    mutate(indicator = fct_relevel(indicator, "HTS_TST",
                                   "HTS_TST_POS",
                                   "TX_NEW",
                                   "TX_CURR",
                                   "TX_NET_NEW",
                                   "VMMC_CIRC",
                                   "PrEP_NEW")) %>% 
    arrange(indicator)

df %>% 
  gt(groupname_col = "Prime Partner",
    rowname_col = "indicator") %>% 
   cols_hide(
    columns = c("fundingagency"))%>% #hide agency
  fmt_number(
    columns = vars(
      `FY21 Q1`,
      `FY21 Q2`,
      `FY21 cumulative`,
      `FY21 targets`),
    decimals = 0
  ) %>% 
  fmt_percent(
    columns = vars(`FY21 Achieved`),
    decimals = 0
  )%>%
  fmt_missing(columns = everything(),
            missing_text = "-")%>%
   tab_options(
    table.font.names = "Source Sans Pro"
    ) %>% 
   cols_width(
    vars(indicator) ~ px(140),
    everything() ~ px(80)
  )%>%
  tab_style(
    style = cell_borders(
      sides = "right",
      weight = px(1.5),
    ),
    locations = cells_body(
      columns = everything(),
      rows = everything()
    ))%>%


  tab_style(style = cell_fill(color = pal[4]),      ## defining the what (the 4th value of the pal object)
              locations = cells_body(                 ## telling it where (ie, the body of a cell)
                columns = vars(`FY21 Achieved`),      ## which col this refers to (note `vars()`)
                rows = `FY21 Achieved` >= 1.1)) %>%   ## the argument
    tab_style(style = cell_fill(color = pal[3]),
              locations = cells_body(
                columns = vars(`FY21 Achieved`),
                rows = `FY21 Achieved` < 1.1)) %>% 
    tab_style(style = cell_fill(color = pal[2]),
              locations = cells_body(
                columns = vars(`FY21 Achieved`),
                rows = `FY21 Achieved` < .9)) %>% 
    tab_style(style = cell_fill(color = pal[1]),
              locations = cells_body(
                columns = vars(`FY21 Achieved`),
                rows = `FY21 Achieved` < .75))%>%
 tab_header(title = "USAID Partners results, performance, and targets FY21 Q1-Q2") %>% 
  tab_source_note("Source: MSD FY20Q2i 2021-05-20")
  
